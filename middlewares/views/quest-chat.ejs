<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
    <link
      rel="icon"
      href="../public/images/Knight_thumbnail01.png"
      type="image/png"
    />
    <%- include('partials/head-tags') %>
    <link rel="stylesheet" href="/chat.css" />
    <script src="/color.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>

  <body class="d-flex flex-column" style="height: 100%">
    <%- include('partials/header') %> <%- include('partials/not-signed-in') %>

    <!-- WebSocket path injected from server -->
    <script>
      const CHAT_WS = "<%= chatWsAddress %>";
      <% if (typeof user !== "undefined" && user) { %>
        const USERNAME = "<%= user %>";
      <% } else { %>
        const USERNAME = null;
      <% } %>

      var selectedQuest = <%- JSON.stringify(startingQuest || null) %>;

      console.log("Starting quest:", JSON.stringify(selectedQuest), "id:", selectedQuest?._id);
      console.log("Chat WS address:", CHAT_WS);
      console.log("Username:", USERNAME);
    </script>

    <main id="main" style="padding: 0em 2em 1em 2em">
      <div class="row chat-container" id="chat-container">
        <div class="col-md-3 threads bg-light p-3">
          <a class="nav-link active" href="<%= otherPageLink %>">
            <i class="fa-solid fa-arrow-left"></i> <%= otherPageTitle %>
          </a>
          <br />
          <h5>Quests</h5>
          <ul class="list-group">
            <% acceptedQuests.forEach((quest) => { %>

            <li
              onclick="selectQuest('<%= quest._id %>')"
              class="list-group-item d-flex justify-content-between align-items-center <%= quest.completed === 'true' ? 'disabled' : '' %> <%= startingQuest != null && quest._id === startingQuest._id ? 'active' : '' %>"
              data-quest-id="<%= quest._id %>"
            >
              <span><%= quest.title %></span>
            </li>

            <% }); %>
          </ul>
        </div>

        <!-- Chat area -->
        <div class="col-md-9 chat-messages d-flex flex-column">
          <div class="align-items-center border-bottom p-2">
            <div class="d-flex justify-content-between p-2">
              <h5 class="mb-0" id="chat-title">Title</h5>

              <div class="d-flex align-items-center gap-2" id="quest-actions">
                <button class="btn btn-light btn-sm" id="descToggleBtn">
                  Show Details <i class="fa-solid fa-caret-down"></i>
                </button>

                <button class="btn btn-sm btn-success" id="resolveBtn">
                  Resolve Quest
                </button>
              </div>
            </div>
            <p id="quest-description" style="display: none">description</p>
          </div>

          <div class="messages flex-grow-1 overflow-auto" id="messages"></div>

          <div class="chat-input mt-auto p-2">
            <form class="d-flex gap-2" id="chatForm">
              <textarea
                id="message"
                rows="3"
                placeholder="Type your message (Markdown supported)..."
              ></textarea>
              <input
                style="display: none"
                type="file"
                class="form-control form-control-sm"
                id="fileInput"
              />
              <button class="btn btn-primary" type="submit" id="sendBtn">
                <i class="fa-solid fa-paper-plane"></i>
              </button>
            </form>
          </div>
        </div>
      </div>
    </main>

    <%- include('partials/footer') %>
  </body>

  <!-- -----------------------------
        WEBSOCKET LOGIC
  ------------------------------ -->
  <script>
    let ws;

    function connectWS() {
      const protocol = location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${protocol}://${location.host}${CHAT_WS}`);

      ws.onopen = () => {
        console.log("WS connected!");
        if (selectedQuest !== null) {
          ws.send(
            JSON.stringify({
              action: "GET_MESSAGES",
              questDbId: selectedQuest._id,
            })
          );
        }
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "MESSAGES_LIST") {
          loadMessages(data.messages);
        } else if (data.type === "SELECT_QUEST") {
          selectedQuest = data.quest;
          console.log("New Selected quest:", JSON.stringify(selectedQuest));
          applySelectedQuest(selectedQuest);
          loadMessages(data.messages);
        } else if (data.type === "NEW_MESSAGE") {
          if (data.questDbId !== selectedQuest._id) {
            console.log("Message does not belong to selected quest");
            //text-bg-primary
            //text-bg-warning
            showMessageToast(
              data.username,
              data.message,
              "#",
              "Another Quest",
              "text-bg-primary"
            );
            return;
          }
          addMessage(data);
        } else if (data.type === "QUEST_RESOLVED") {
          window.location.reload();
        }
      };

      ws.onclose = () => {
        console.log("WS disconnected… reconnecting");
        setTimeout(connectWS, 1000);
      };
    }
    connectWS();
    applySelectedQuest(selectedQuest);

    // ---------------------------
    // Rendering messages
    // ---------------------------
    const msgContainer = document.getElementById("messages");

    function addMessage(msg) {
      const el = document.createElement("div");
      el.className = "chat-message";
      if (msg.username === USERNAME) {
        el.classList.add("blue-message");
      }

      var messageBodyHTML = marked.parse(msg.message);

      el.innerHTML = `
        <div class="author">${msg.username} <span class="time">${new Date(
        msg.timestamp
      ).toLocaleTimeString()}</span></div>
        <div class="text">${messageBodyHTML}</div>
        ${
          msg.attachments && msg.attachments.length
            ? `
          <div class="attachments mt-1">
            ${msg.attachments
              .map((a) => `<a href="${a}" target="_blank">${a}</a>`)
              .join("<br/>")}
          </div>
        `
            : ""
        }
      `;

      msgContainer.appendChild(el);
      msgContainer.scrollTop = msgContainer.scrollHeight;
    }

    function applySelectedQuest(quest) {
      const titleEl = document.querySelector("#chat-title");
      const descriptionEl = document.querySelector("#quest-description");
      const resolveButtonEl = document.getElementById("resolveBtn");
      const chatFormEl = document.getElementById("chatForm");

      // Helper to disable every input/textarea/button inside the form
      const setFormDisabled = (disabled) => {
        chatFormEl.querySelectorAll("input, textarea, button").forEach((el) => {
          el.disabled = disabled;
        });
      };

      if (!quest) {
        titleEl.textContent = "No quest selected";
        descriptionEl.textContent = "";
        resolveButtonEl.style.display = "none";
        setFormDisabled(true);
        applyTheme("#f8f9fa");
        return;
      }

      // --- Quest selected ---
      titleEl.textContent =
        quest.title + (quest.completed == true ? " (resolved)" : "");

      descriptionEl.innerHTML = "";
      if (quest.username !== USERNAME) {
        descriptionEl.innerHTML += `<b class='block-bold'>#${quest.username}</b>`;
      }

      if (quest.acceptedUsers.length > 0) {
        descriptionEl.innerHTML += `<b class='block-bold'>Accepted by: ${quest.acceptedUsers.join(
          ", "
        )}</b>${quest.description}`;
      } else {
        descriptionEl.innerHTML += `<b class='block-bold'>No one has accepted this quest yet.</b>${quest.description}`;
      }

      applyTheme(quest.color);

      // Highlight active quest
      document.querySelectorAll("li.list-group-item").forEach((li) => {
        li.classList.toggle("active", li.dataset.questId === quest._id);
      });

      // Show resolve/delete button
      resolveButtonEl.style.display = "inline";
      resolveButtonEl.textContent =
        quest.completed == true ? "Delete Quest" : "Resolve Quest";
      console.log("quest.completed:", quest.completed);
      setFormDisabled(quest.completed == true);
    }

    function loadMessages(list) {
      msgContainer.innerHTML = "";
      list.forEach(addMessage);
    }

    // ---------------------------
    // Sending messages
    // ---------------------------
    document.getElementById("chatForm").addEventListener("submit", (e) => {
      console.log("Sending message...");
      e.preventDefault();

      const message = document.getElementById("message").value;
      if (message.trim() === "") return;

      const fileInput = document.getElementById("fileInput");

      console.log("Message:", message);
      console.log("Attachments:", fileInput.files);

      let attachments = [];
      if (fileInput.files.length > 0) {
        attachments.push("/uploads/" + fileInput.files[0].name);
      }

      ws.send(
        JSON.stringify({
          action: "SEND_MESSAGE",
          questDbId: selectedQuest._id,
          message,
          attachments,
        })
      );

      document.getElementById("message").value = "";
      fileInput.value = "";
    });

    function selectQuest(questId) {
      ws.send(
        JSON.stringify({
          action: "SELECT_QUEST",
          questDbId: questId,
        })
      );
    }

    document.getElementById("resolveBtn").addEventListener("click", () => {
      if (!selectedQuest) return;

      const yes = confirm(
        "Are you sure?\nThis will permanently delete the quest thread and all participating users will no longer be able to send messages."
      );

      if (!yes) return; // user bailed, good for them

      ws.send(
        JSON.stringify({
          action: "RESOLVE_QUEST",
          questDbId: selectedQuest._id,
        })
      );
    });

    // Auto-adjust height
    function adjustChatHeight() {
      const header = document.getElementById("header-padding");
      const footer = document.getElementById("site-footer");
      const main = document.getElementById("main");
      const chat = document.getElementById("chat-container");

      const headerH = parseFloat(header?.style.marginBottom) || 0;
      const footerH = footer?.offsetHeight || 0;

      const style = getComputedStyle(main);
      const paddingTop = parseFloat(style.paddingTop) || 0;
      const paddingBottom = parseFloat(style.paddingBottom) || 0;

      console.log(
        "headerH:",
        headerH,
        "footerH:",
        footerH,
        "paddingTop:",
        paddingTop,
        "paddingBottom:",
        paddingBottom
      );
      const totalUsed = headerH + footerH + paddingTop + paddingBottom;

      chat.style.height = `calc(100vh - ${totalUsed}px)`;
      chat.style.opacity = "1";
    }

    window.addEventListener("load", adjustChatHeight);
    window.addEventListener("resize", adjustChatHeight);
    setTimeout(adjustChatHeight, 200);

    const desc = document.getElementById("quest-description");
    const toggleBtn = document.getElementById("descToggleBtn");

    toggleBtn.addEventListener("click", () => {
      const isVisible = desc.style.display !== "none";

      if (isVisible) {
        desc.style.display = "none";
        toggleBtn.innerHTML =
          'Show Details <i class="fa-solid fa-caret-down"></i>';
      } else {
        desc.style.display = "block";
        toggleBtn.innerHTML =
          'Hide Details <i class="fa-solid fa-caret-up"></i>';
      }
    });

    function applyTheme(baseHex) {
      baseHex = muteIfUgly(baseHex);
      const root = document.documentElement;

      // Convert hex → RGB
      function hexToRgb(hex) {
        hex = hex.replace("#", "");
        if (hex.length === 3) {
          hex = hex
            .split("")
            .map((c) => c + c)
            .join("");
        }
        const num = parseInt(hex, 16);
        return {
          r: (num >> 16) & 255,
          g: (num >> 8) & 255,
          b: num & 255,
        };
      }

      // Return perceived brightness 0–255
      function brightness({ r, g, b }) {
        return (r * 299 + g * 587 + b * 114) / 1000;
      }

      // Make a darker color (20% darker)
      function darken({ r, g, b }, factor = 0.2) {
        return {
          r: Math.max(0, Math.floor(r * (1 - factor))),
          g: Math.max(0, Math.floor(g * (1 - factor))),
          b: Math.max(0, Math.floor(b * (1 - factor))),
        };
      }

      // Convert RGB → hex
      function rgbToHex({ r, g, b }) {
        return (
          "#" + [r, g, b].map((v) => v.toString(16).padStart(2, "0")).join("")
        );
      }

      // Do the magic
      const primaryRGB = hexToRgb(baseHex);
      const primaryHex = rgbToHex(primaryRGB);

      const complimentRGB = darken(primaryRGB, 0.25);
      const complimentHex = rgbToHex(complimentRGB);

      const textForeground = brightness(primaryRGB) < 130 ? "#fff" : "#333";

      const complimentForeground =
        brightness(complimentRGB) < 130 ? "#fff" : "#333";

      // Apply CSS variables
      root.style.setProperty("--color-primary", primaryHex);
      root.style.setProperty("--color-compliment", complimentHex);
      root.style.setProperty("--text-foreground", textForeground);
      root.style.setProperty("--compliment-foreground", complimentForeground);
    }
  </script>
  <%- include('partials/chat-ws', { requestHelpWs: null, questBoardWs: null })
  %>
</html>
