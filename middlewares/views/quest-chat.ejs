<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
    <%- include('partials/head-tags') %>
    <link rel="stylesheet" href="/chat.css" />
  </head>

  <body class="d-flex flex-column" style="height: 100%">
    <%- include('partials/header') %> <%- include('partials/not-signed-in') %>

    <!-- WebSocket path injected from server -->
    <script>
      const CHAT_WS = "<%= chatWsAddress %>";
      <% if (typeof user !== "undefined" && user) { %>
        const USERNAME = "<%= user %>";
      <% } else { %>
        const USERNAME = null;
      <% } %>

      var selectedQuest = <%- JSON.stringify(startingQuest || null) %>;

      console.log("Starting quest:", JSON.stringify(selectedQuest), "id:", selectedQuest?._id);
      console.log("Chat WS address:", CHAT_WS);
      console.log("Username:", USERNAME);
    </script>

    <main id="main" style="padding: 0em 2em 1em 2em">
      <div class="row chat-container" id="chat-container">
        <div class="col-md-3 threads bg-light p-3">
          <a class="nav-link active" href="<%= otherPageLink %>">
            <i class="fa-solid fa-arrow-left"></i> <%= otherPageTitle %>
          </a>
          <br />
          <h5>Quests</h5>
          <ul class="list-group">
            <% acceptedQuests.forEach((quest) => { %>

            <li
              onclick="selectQuest('<%= quest._id %>')"
              class="list-group-item d-flex justify-content-between align-items-center <%= quest.completed === 'true' ? 'disabled' : '' %> <%= startingQuest != null && quest._id === startingQuest._id ? 'active' : '' %>"
              data-quest-id="<%= quest._id %>"
            >
              <span><%= quest.title %></span>
            </li>

            <% }); %>
          </ul>
        </div>

        <!-- Chat area -->
        <div class="col-md-9 chat-messages d-flex flex-column">
          <div
            class="d-flex justify-content-between align-items-center border-bottom p-2"
          >
            <h5 class="mb-0" id="chat-title">Homework Help</h5>
            <div>
              <button class="btn btn-sm btn-success" id="resolveBtn">
                Resolve Quest
              </button>
            </div>
          </div>

          <div class="messages flex-grow-1 overflow-auto" id="messages"></div>

          <div class="chat-input mt-auto p-2">
            <form class="d-flex gap-2" id="chatForm">
              <textarea 
                id="message"
                rows="3"
                placeholder="Type your message..."
              ></textarea>
              <input style="display: none;"
                type="file"
                class="form-control form-control-sm"
                id="fileInput"
              />
              <button class="btn btn-primary" type="submit">Send</button>
            </form>
          </div>
        </div>
      </div>
    </main>

    <%- include('partials/footer') %>
  </body>

  <!-- -----------------------------
        WEBSOCKET LOGIC
  ------------------------------ -->
  <script>
    let ws;

    function connectWS() {
      ws = new WebSocket(`ws://${location.host}${CHAT_WS}`);

      ws.onopen = () => {
        console.log("WS connected!");
        if (selectedQuest !== null) {
          ws.send(
            JSON.stringify({
              action: "GET_MESSAGES",
              questDbId: selectedQuest._id,
            })
          );
        }
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "MESSAGES_LIST") {
          loadMessages(data.messages);
        } else if (data.type === "SELECT_QUEST") {
          selectedQuest = data.quest;
          console.log("New Selected quest:", JSON.stringify(selectedQuest));
          applySelectedQuest(selectedQuest);
          loadMessages(data.messages);
        } else if (data.type === "NEW_MESSAGE") {
          addMessage(data);
        } else if (data.type === "QUEST_RESOLVED") {
          window.location.reload();
        }
      };

      ws.onclose = () => {
        console.log("WS disconnectedâ€¦ reconnecting");
        setTimeout(connectWS, 1000);
      };
    }
    connectWS();
    applySelectedQuest(selectedQuest);

    // ---------------------------
    // Rendering messages
    // ---------------------------
    const msgContainer = document.getElementById("messages");

    function addMessage(msg) {
      const el = document.createElement("div");
      el.className = "chat-message";
      if (msg.username === USERNAME) {
        el.classList.add("blue-message");
      }

      el.innerHTML = `
        <div class="author">${msg.username} <span class="time">${new Date(
        msg.timestamp
      ).toLocaleTimeString()}</span></div>
        <div class="text">${msg.message}</div>
        ${
          msg.attachments && msg.attachments.length
            ? `
          <div class="attachments mt-1">
            ${msg.attachments
              .map((a) => `<a href="${a}" target="_blank">${a}</a>`)
              .join("<br/>")}
          </div>
        `
            : ""
        }
      `;

      msgContainer.appendChild(el);
      msgContainer.scrollTop = msgContainer.scrollHeight;
    }

    function applySelectedQuest(quest) {
      const titleEl = document.querySelector("#chat-title");
      const resolveButtonEl = document.getElementById("resolveBtn");
      const chatFormEl = document.getElementById("chatForm");

      // Helper to disable every input/textarea/button inside the form
      const setFormDisabled = (disabled) => {
        chatFormEl.querySelectorAll("input, textarea, button").forEach((el) => {
          el.disabled = disabled;
        });
      };

      if (!quest) {
        titleEl.textContent = "No quest selected";
        resolveButtonEl.style.display = "none";
        setFormDisabled(true);
        return;
      }

      // --- Quest selected ---
      titleEl.textContent = quest.title;

      // Highlight active quest
      document.querySelectorAll("li.list-group-item").forEach((li) => {
        li.classList.toggle("active", li.dataset.questId === quest._id);
      });

      // Show resolve/delete button
      resolveButtonEl.style.display = "inline";
      resolveButtonEl.textContent = quest.completed
        ? "Delete Quest"
        : "Resolve Quest";

      // Enable controls again
      setFormDisabled(false);
    }

    function loadMessages(list) {
      msgContainer.innerHTML = "";
      list.forEach(addMessage);
    }

    // ---------------------------
    // Sending messages
    // ---------------------------
    document.getElementById("chatForm").addEventListener("submit", (e) => {
      console.log("Sending message...");
      e.preventDefault();

      const message = document.getElementById("message").value;
      const fileInput = document.getElementById("fileInput");

      console.log("Message:", message);
      console.log("Attachments:", fileInput.files);

      let attachments = [];
      if (fileInput.files.length > 0) {
        attachments.push("/uploads/" + fileInput.files[0].name);
      }

      ws.send(
        JSON.stringify({
          action: "SEND_MESSAGE",
          questDbId: selectedQuest._id,
          message,
          attachments,
        })
      );

      document.getElementById("message").value = "";
      fileInput.value = "";
    });

    function selectQuest(questId) {
      ws.send(
        JSON.stringify({
          action: "SELECT_QUEST",
          questDbId: questId,
        })
      );
    }

    document.getElementById("resolveBtn").addEventListener("click", () => {
      if (selectedQuest != null) {
        ws.send(
          JSON.stringify({
            action: "RESOLVE_QUEST",
            questDbId: selectedQuest._id,
          })
        );
      }
    });

    // Auto-adjust height
    function adjustChatHeight() {
      const header = document.getElementById("header-padding");
      const footer = document.getElementById("site-footer");
      const main = document.getElementById("main");
      const chat = document.getElementById("chat-container");

      const headerH = parseFloat(header?.style.height) || 0;
      const footerH = footer?.offsetHeight || 0;

      const style = getComputedStyle(main);
      const paddingTop = parseFloat(style.paddingTop) || 0;
      const paddingBottom = parseFloat(style.paddingBottom) || 0;

      const totalUsed = headerH + footerH + paddingTop + paddingBottom;
      chat.style.height = `calc(100vh - ${totalUsed}px)`;
      chat.style.opacity = "1";
    }

    window.addEventListener("load", adjustChatHeight);
    window.addEventListener("resize", adjustChatHeight);
    setTimeout(adjustChatHeight, 200);
  </script>
</html>
