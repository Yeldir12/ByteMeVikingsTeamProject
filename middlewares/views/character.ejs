<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quest Board</title>
    <%- include('partials/head-tags') %>
  </head>
  <body>
    <script>
      // character is either null or an object from the session
      const character = <%- JSON.stringify(character || null) %>;
      const CHARACTER_POINTS = <%- characterPoints || 0 %>;
    </script>

    <%- include('partials/header') %> <%- include('partials/not-signed-in') %>
    <main id="character-page" class="container py-4">
      <!-- <h1 id="character-title" class="text-center mb-5">Your Character</h1> -->

      <!-- Profile Card -->
      <section id="profile-card" class="card text-center mb-5 shadow-sm">
        <div class="card-body">
          <img
            src="/images/Ranger_thumbnail01.png"
            alt="Character Avatar"
            id="avatar"
            style="height: 120px"
          />

          <% if (typeof user !== "undefined" && user) { %>
          <h2 id="player-name" class="card-title">The Mighty <%= user %></h2>
          <% } %>

          <p class="mb-1">
            Points:
            <span id="player-points" class="badge bg-success"></span>
          </p>
          <p>
            Level:
            <span id="player-status" class="badge">Loading...</span>
          </p>
        </div>
      </section>

      <!-- Progress / Achievements -->
      <!-- <section id="progress" class="mb-5">
        <h2 class="mb-3">Progress & Achievements</h2>
        <ul class="list-group">
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
          >
            Earned 20 points for helping on Quest #12
            <span class="badge bg-primary rounded-pill">+20</span>
          </li>
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
          >
            Rated 5 stars by Quest Seeker
            <span class="badge bg-warning text-dark rounded-pill"
              >⭐️⭐️⭐️⭐️⭐️</span
            >
          </li>
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
          >
            Unlocked privilege: Access to Elite Board
            <span class="badge bg-success rounded-pill">NEW</span>
          </li>
        </ul>
      </section> -->

      <form action="/character" method="POST" id="character-form" class="mb-5">
        <section id="customization">
          <h2 class="mb-3">Customize Your Character</h2>

          <!-- Hidden fields to store actual submitted values -->
          <input type="hidden" name="gender" id="gender-input" />
          <input type="hidden" name="class" id="class-input" />
          <input type="hidden" name="armor" id="armor-input" />
          <input type="hidden" name="weapon" id="weapon-input" />

          <!-- Gender Selection -->
          <div id="gender-selection" class="mb-3">
            <h3 class="mb-2">Choose Gender</h3>
            <div class="btn-group">
              <button
                type="button"
                class="btn btn-outline-secondary gender-btn"
                data-value="male"
              >
                Male
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary gender-btn"
                data-value="female"
              >
                Female
              </button>
            </div>
          </div>

          <!-- Class Selection -->
          <div id="class-selection" class="mb-3">
            <h3 class="mb-2">Choose Class</h3>
            <div class="btn-group">
              <button
                type="button"
                class="btn btn-outline-secondary class-btn"
                data-value="wizard"
              >
                Wizard
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary class-btn"
                data-value="knight"
              >
                Knight
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary class-btn"
                data-value="ranger"
              >
                Ranger
              </button>
            </div>
          </div>

          <!-- Armor Selection -->
          <div id="armor-selection" class="mb-4" style="display: none">
            <h3 class="mb-2">Outfits & Armor</h3>
            <div class="btn-group flex-wrap">
              <button
                type="button"
                class="btn btn-outline-dark m-1 armor-btn"
                data-value="basic-armor"
              >
                Basic Armor
              </button>
              <button
                type="button"
                class="btn btn-outline-dark m-1 armor-btn"
                data-value="elite-armor"
              >
                Elite Armor
              </button>
              <button
                type="button"
                class="btn btn-outline-dark m-1 armor-btn"
                data-value="legendary-robes"
              >
                Legendary Robes
              </button>
            </div>
          </div>

          <!-- Weapons / Shields -->
          <div id="weapon-selection" class="mb-4" style="display: none">
            <h3 class="mb-2">Weapons & Shields</h3>
            <div class="btn-group flex-wrap">
              <button
                type="button"
                class="btn btn-outline-success m-1 weapon-btn"
                data-value="sword"
              >
                Sword
              </button>
              <button
                type="button"
                class="btn btn-outline-success m-1 weapon-btn"
                data-value="bow"
              >
                Bow
              </button>
              <button
                type="button"
                class="btn btn-outline-success m-1 weapon-btn"
                data-value="shield"
              >
                Shield
              </button>
            </div>
          </div>

          <!-- Submit -->
          <button type="submit" class="btn btn-primary mt-4">
            Save Changes
          </button>
        </section>
      </form>

      <!-- Visual Status Bar
      <section id="status-bar" class="mb-5">
        <h2 class="mb-2">Experience</h2>
        <div class="progress" style="height: 25px">
          <div
            id="xp-bar"
            class="progress-bar progress-bar-striped progress-bar-animated bg-info"
            role="progressbar"
            style="width: 60%"
            aria-valuenow="60"
            aria-valuemin="0"
            aria-valuemax="100"
          >
            60%
          </div>
        </div>
      </section> -->
    </main>

    <%- include('partials/footer') %>
  </body>
  <script>
    function getLevel(points) {
      if (points >= 500) return { level: "Legend", color: "bg-danger" };
      if (points >= 400) return { level: "Master", color: "bg-danger" };
      if (points >= 300) return { level: "Expert", color: "bg-purple" };
      if (points >= 200) return { level: "Veteran", color: "bg-primary" };
      if (points >= 100) return { level: "Adept", color: "bg-info" };
      if (points >= 50) return { level: "Apprentice", color: "bg-success" };
      if (points >= 20)
        return { level: "Squire", color: "bg-warning text-dark" };
      if (points >= 10)
        return { level: "Novice", color: "bg-warning text-dark" };
      return { level: "Beginner", color: "bg-primary" };
    }

    // Update the DOM
    function updatePlayerStatus(points) {
      console.log("UPDATING PLAYER STATUS ", points);
      const lvl = getLevel(points);

      const pointsEl = document.getElementById("player-points");
      const statusEl = document.getElementById("player-status");

      if (pointsEl) pointsEl.textContent = points;

      if (statusEl) {
        statusEl.textContent = lvl.level;
        statusEl.className = "badge " + lvl.color;
      }
    }

    // Apply immediately on page load
    updatePlayerStatus(CHARACTER_POINTS);


    function updateAvatar(character) {
      const avatarEl = document.getElementById("avatar");
      if (!avatarEl || !character) return;

      const { gender, class: charClass } = character;
      console.log("UPDATING CHARACTER ", character);
      let imgPath = "/images/variants/";

      // Determine image filename based on gender + class
      if (gender === "male") {
        if (charClass === "wizard") imgPath += "male-wizard.png";
        else if (charClass === "ranger") imgPath += "male-ranger.png";
        else if (charClass === "knight") imgPath += "male-knight.png";
        else imgPath += "male-knight.png";
      } else if (gender === "female") {
        if (charClass === "wizard") imgPath += "female-wizard.png";
        else if (charClass === "ranger") imgPath += "female-ranger.png";
        else if (charClass === "knight") imgPath += "female-knight.png";
        else imgPath += "female-knight.png";
      } else {
        imgPath += "male-knight.png";
      }
      console.log(imgPath);
      avatarEl.src = imgPath;
    }

    // Call it once on page load
    updateAvatar(character);

    // Generic helper to update hidden inputs + highlight buttons
    function setupSelection(buttonClass, inputId) {
      document.querySelectorAll(buttonClass).forEach((btn) => {
        btn.addEventListener("click", () => {
          // Update hidden input
          document.getElementById(inputId).value = btn.dataset.value;

          // Highlight selected button
          document
            .querySelectorAll(buttonClass)
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
        });
      });
    }

    setupSelection(".gender-btn", "gender-input");
    setupSelection(".class-btn", "class-input");
    setupSelection(".armor-btn", "armor-input");
    setupSelection(".weapon-btn", "weapon-input");
  </script>
        <%- include('partials/chat-ws', { 
          requestHelpWs: '/ws/request-help/chat', 
          questBoardWs: '/ws/quest-board/chat' 
    }) %>
</html>
